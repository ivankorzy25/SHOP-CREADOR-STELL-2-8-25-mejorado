<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Catálogo KOR - Sistema de Gestión de Productos</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    :root {
        --primary-color: #000000;
        --secondary-color: #FF6B35;
        --accent-color: #FFD23F;
        --success-color: #27ae60;
        --info-color: #3498db;
        --warning-color: #FFD23F;
        --danger-color: #e74c3c;
        --dark-color: #1a1a1a;
        --light-color: #f8f9fa;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #FFD23F 0%, #FF6B35 50%, #000000 100%);
        color: #333;
        min-height: 100vh;
    }

    .navbar {
        background: linear-gradient(90deg, var(--primary-color) 0%, #1a1a1a 100%);
        box-shadow: 0 4px 10px rgba(0,0,0,.3);
        border-bottom: 3px solid var(--secondary-color);
    }

    .navbar-brand {
        font-weight: 900;
        color: var(--accent-color) !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
    }

    /* Panel de Cotización */
    .cotizacion-panel {
        background: rgba(255, 215, 63, 0.9);
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        border: 2px solid var(--secondary-color);
    }

    .cotizacion-panel .cotizacion-label {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 0.9rem;
    }

    .cotizacion-panel .cotizacion-valor {
        font-size: 1.2rem;
        font-weight: 900;
        color: var(--secondary-color);
        min-width: 120px;
    }

    .cotizacion-panel input[type="date"] {
        background: white;
        border: 2px solid var(--secondary-color);
        border-radius: 5px;
        padding: 0.25rem 0.5rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .cotizacion-panel .btn-cotizacion {
        background: var(--secondary-color);
        color: white;
        border: none;
        padding: 0.25rem 1rem;
        border-radius: 5px;
        font-weight: 700;
        transition: all 0.3s ease;
    }

    .cotizacion-panel .btn-cotizacion:hover {
        background: #ff8c5a;
        transform: translateY(-2px);
    }

    .cotizacion-spinner {
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--secondary-color);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Ajustes para el header */
    .header-section {
        background: linear-gradient(135deg, var(--primary-color) 0%, #222 100%);
        color: white;
        padding: 1rem 0;
        margin-bottom: 1.5rem;
        border-bottom: 3px solid var(--secondary-color);
        position: relative;
        overflow: hidden;
    }

    .header-section::before {
        content: "";
        position: absolute;
        top: -25%;
        right: -5%;
        width: 150px;
        height: 150px;
        background: radial-gradient(circle, var(--accent-color) 0%, transparent 70%);
        opacity: 0.1;
    }

    .header-section h1 {
        font-weight: 600;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
        font-size: 1.75rem;
    }

    /* Ajustes para cotización en modal */
    .modal-cotizacion-info {
        background: linear-gradient(135deg, #FFD23F 0%, #FF6B35 100%);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .modal-cotizacion-info .cotizacion-title {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .modal-cotizacion-info .cotizacion-value {
        font-size: 1.5rem;
        font-weight: 900;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .modal-cotizacion-info .cotizacion-date {
        font-size: 0.8rem;
        color: var(--primary-color);
        margin-top: 0.5rem;
    }

    .filter-card, .stats-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 20px rgba(0,0,0,.2);
        border: 2px solid transparent;
        background-image: linear-gradient(white, white), 
                          linear-gradient(45deg, var(--secondary-color), var(--accent-color));
        background-origin: border-box;
        background-clip: padding-box, border-box;
        transition: all 0.3s ease;
    }

    .table-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 20px rgba(0,0,0,.2);
    }

    .filter-card:hover, .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(255, 107, 53, 0.3);
    }

    .stats-card {
        background: white;
    }

    .stats-number {
        font-size: 2.5rem;
        font-weight: 900;
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .btn-primary {
        background: linear-gradient(45deg, var(--primary-color), #333);
        border: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .btn-primary:hover {
        background: linear-gradient(45deg, #333, var(--primary-color));
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    }

    .btn-success {
        background: linear-gradient(45deg, var(--secondary-color), #ff8c5a);
        border: none;
    }

    .btn-success:hover {
        background: linear-gradient(45deg, #ff8c5a, var(--secondary-color));
    }

    .btn-outline-secondary {
        border: 2px solid var(--accent-color);
        color: var(--primary-color);
    }

    .btn-outline-secondary:hover {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: var(--primary-color);
    }

    .table th {
        background: linear-gradient(90deg, var(--primary-color), #333);
        color: var(--accent-color);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 1px;
        padding: 1rem 0.5rem;
        border: none;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(255, 215, 63, 0.05);
    }

    .table-hover tbody tr:hover {
        background-color: rgba(255, 107, 53, 0.1);
    }

    .badge-stock {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        font-weight: 700;
    }

    .categoria-badge {
        background: linear-gradient(45deg, var(--secondary-color), var(--accent-color)) !important;
        color: var(--primary-color) !important;
        font-weight: 700;
    }

    .modal-header {
        background: linear-gradient(90deg, var(--primary-color), #333);
        color: var(--accent-color);
        border-bottom: 3px solid var(--secondary-color);
    }

    .modal-header .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: linear-gradient(45deg, var(--secondary-color), var(--accent-color)) !important;
        color: var(--primary-color) !important;
        border: 1px solid var(--secondary-color) !important;
        font-weight: 700;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: var(--accent-color) !important;
        color: var(--primary-color) !important;
        border-color: var(--accent-color) !important;
    }

    .kor-footer {
        background: linear-gradient(90deg, var(--primary-color), #1a1a1a);
        color: white;
        padding: 2rem 0;
        margin-top: 3rem;
        border-top: 5px solid var(--secondary-color);
        text-align: center;
    }

    .kor-footer .contact-info {
        display: flex;
        justify-content: center;
        gap: 3rem;
        margin-top: 1rem;
    }

    .kor-footer .contact-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--accent-color);
        font-weight: 600;
    }

    .kor-footer .contact-item i {
        color: var(--secondary-color);
        font-size: 1.2rem;
    }

    .loading-overlay {
        background: rgba(0,0,0,0.9);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .spinner-wrapper {
        text-align: center;
        color: white;
    }

    .spinner-border {
        border-color: var(--accent-color);
        border-right-color: var(--secondary-color);
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(255, 107, 53, 0.25);
    }

    .bg-warning {
        background: var(--accent-color) !important;
        color: var(--primary-color) !important;
    }

    /* Estilos Carrusel Modal Detalles */
    #productImageCarousel .carousel-inner img {
        max-height: 250px;
        object-fit: contain;
        border-radius: 0.375rem;
    }

    .product-image-container {
        max-width: 400px;
        margin: 0 auto;
    }

    #productImageCarousel {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
    }

    #productImageCarousel .carousel-indicators {
        bottom: 5px;
    }

    #productImageCarousel .carousel-indicators button {
        background-color: rgba(0, 0, 0, 0.5);
        border: none;
    }

    #productImageCarousel .carousel-indicators button.active {
        background-color: var(--secondary-color);
    }

    #productImageCarousel .carousel-control-prev,
    #productImageCarousel .carousel-control-next {
        background: rgba(0, 0, 0, 0.3);
        width: 35px;
        height: 35px;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #productImageCarousel .carousel-control-prev {
        left: 10px;
    }

    #productImageCarousel .carousel-control-next {
        right: 10px;
    }

    #productImageCarousel .carousel-control-prev:hover,
    #productImageCarousel .carousel-control-next:hover {
        background: rgba(0, 0, 0, 0.6);
    }
    
    .modal-body .table td {
        padding: 0.3rem 0.5rem;
        font-size: 0.9rem;
    }

    .modal-body h6 {
        font-size: 1rem;
        font-weight: 600;
    }

    .security-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.875rem;
        margin-left: 1rem;
    }

    .security-enabled {
        background: var(--success-color);
        color: white;
    }

    .security-disabled {
        background: var(--danger-color);
        color: white;
    }

    /* Estilos para los controles de ajuste */
    .controles-ajuste-precios .input-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .controles-ajuste-precios input[type="number"] {
        max-width: 80px;
    }

    .controles-ajuste-precios .form-text {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    /* Animación suave para cambios de precio */
    .precio-venta-sin-iva,
    .precio-venta-con-iva,
    .precio-venta-ars-sin-iva,
    .precio-venta-ars-con-iva {
        transition: all 0.3s ease;
    }

    /* Resaltar cuando hay ajustes activos */
    .controles-ajuste-precios input[type="number"]:not([value="0"]) {
        background-color: #fffbf0;
        border-color: #FF6B35;
    }
</style>
</head>
<body>
    <!-- Contenido Principal -->
    <div class="main-content" id="mainContent">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner-wrapper">
                <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3">Procesando datos...</p>
            </div>
        </div>

        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <div style="background: white; padding: 5px 15px; border-radius: 8px; margin-right: 15px;">
                        <div id="korLogoNav"></div>
                    </div>
                    <span style="color: var(--accent-color); font-weight: 700; font-size: 1.5rem;">Catálogo</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <!-- Panel de Cotización integrado en la navbar -->
                    <div class="cotizacion-panel ms-auto me-3" id="cotizacionPanel" style="display: none;">
                        <span class="cotizacion-label">USD/ARS:</span>
                        <span class="cotizacion-valor" id="cotizacionActual">
                            <div class="cotizacion-spinner"></div>
                        </span>
                        <input type="date" id="fechaCotizacion" class="form-control form-control-sm" style="width: 150px;">
<button class="btn btn-cotizacion btn-sm" onclick="actualizarCotizacion()" title="Actualizar cotización" aria-label="Actualizar cotización">
    <i class="fas fa-sync-alt"></i>
</button>
                    </div>
                    
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="mostrarEstadisticas()">
                                <i class="fas fa-chart-line me-1"></i>Estadísticas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="mostrarModalExportacion()">
                                <i class="fas fa-file-export me-1"></i>Exportar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="mostrarModalExportacionCompleta()">
                                <i class="fas fa-save me-1"></i>Guardar Catálogo
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#configuracionModal">
                                <i class="fas fa-cog me-1"></i>Configuración
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="dolar_avanzado.html" target="_blank">
                                <i class="fas fa-chart-area me-1"></i>Dólar Avanzado
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="header-section text-center">
            <div class="container">
                <h1 class="mb-1 mt-1">Sistema de Gestión de Productos KOR</h1>
                <span id="securityStatus" class="security-status security-disabled">
                    <i class="fas fa-unlock me-1"></i>Sin Protección
                </span>
            </div>
        </div>

        <div class="container-fluid px-md-4">
            <div class="row mb-4" id="statisticsRow" style="display: none;">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Total Productos</h6>
                                <div class="stats-number" id="totalProductos">0</div>
                            </div>
                            <div class="text-primary opacity-50">
                                <i class="fas fa-boxes fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Familias</h6>
                                <div class="stats-number" id="totalFamilias">0</div>
                            </div>
                            <div class="text-info opacity-50">
                                <i class="fas fa-tags fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">En Stock</h6>
                                <div class="stats-number" id="totalStock">0</div>
                            </div>
                            <div class="text-success opacity-50">
                                <i class="fas fa-check-circle fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Sin Stock</h6>
                                <div class="stats-number" id="totalSinStock">0</div>
                            </div>
                            <div class="text-danger opacity-50">
                                <i class="fas fa-times-circle fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="filter-card">
                        <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filtros Avanzados</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold" for="filtroFamilia">Familia</label>
                                <select class="form-select" id="filtroFamilia">
                                    <option value="">Todas las familias</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold" for="filtroMarca">Marca</label>
                                <select class="form-select" id="filtroMarca">
                                    <option value="">Todas las marcas</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold" for="filtroCombustible">Combustible</label>
                                <select class="form-select" id="filtroCombustible">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold" for="filtroStock">Stock</label>
                                <select class="form-select" id="filtroStock">
                                    <option value="">Todos</option>
                                    <option value="Disponible">Disponible</option>
                                    <option value="Sin Stock">Sin Stock</option>
                                    <option value="Consultar">Consultar</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold" for="filtroCabina">Tipo de Cabina</label>
                                <select class="form-select" id="filtroCabina">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold" for="filtroTTA">Con TTA</label>
                                <select class="form-select" id="filtroTTA">
                                    <option value="">Todos</option>
                                    <option value="Si">Con TTA Incluido</option>
                                    <option value="No">Sin TTA</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Rango de Precio (USD)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="precioMin" placeholder="Mín">
                                    <span class="input-group-text">-</span>
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="precioMax" placeholder="Máx">
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Rango de Potencia</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="potenciaMin" placeholder="Mín">
<select class="form-select flex-grow-0" id="unidadPotencia" style="max-width: 100px;" aria-label="Unidad de potencia">
    <option value="">Unidad</option>
</select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold" for="busquedaTexto">Búsqueda por texto</label>
                                <input type="text" class="form-control" id="busquedaTexto" placeholder="Buscar en modelo, descripción o características...">
                            </div>
                            <div class="col-md-6 mb-3 align-self-end">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-primary flex-fill" onclick="aplicarFiltros()">
                                        <i class="fas fa-search me-2"></i>Buscar
                                    </button>
                                    <button class="btn btn-outline-secondary flex-fill" onclick="limpiarFiltros()">
                                        <i class="fas fa-eraser me-2"></i>Limpiar
                                    </button>
                                    <button class="btn btn-info flex-fill" onclick="recargarDatosAlmacenados()">
                                        <i class="fas fa-sync-alt me-2"></i>Re-cargar Datos
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Lista de Productos</h5>
                    <div>
                        <a href="dolar_avanzado.html" target="_blank" class="btn btn-info btn-sm me-2">
                            <i class="fas fa-dollar-sign me-2"></i>Ver Dólar Avanzado
                        </a>
                        <button class="btn btn-success btn-sm" onclick="mostrarModalExportacion()">
                            <i class="fas fa-file-excel me-2"></i>Exportar Vista Actual
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="productosTable" class="table table-striped table-hover w-100">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Modelo</th>
                                <th>Marca</th>
                                <th>Potencia</th>
                                <th>Motor</th>
                                <th>Combustible</th>
                                <th>Cabina</th>
                                <th>TTA</th>
                                <th>Precio USD</th>
                                <th>Precio ARS</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productosTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footer KOR -->
        <footer class="kor-footer">
            <div class="container">
                <div style="background: white; display: inline-block; padding: 15px 30px; border-radius: 10px; margin-bottom: 1.5rem;">
                    <div id="korLogoFooter"></div>
                </div>
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span>11 3956 3099</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-globe"></i>
                        <span>www.generadores.ar</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span>info@generadores.ar</span>
                    </div>
                </div>
                <p style="margin-top: 1rem; color: #999; font-size: 0.9rem;">© 2024 KOR Generadores - Todos los derechos reservados</p>
            </div>
        </footer>

        <!-- Modal Detalles -->
        <div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detallesModalLabel">Detalles del Producto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body" id="detallesModalBody">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-success" onclick="exportarProductoSeleccionadoExcel()">
                            <i class="fas fa-file-excel me-2"></i>Exportar Excel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="imprimirModal()">
                            <i class="fas fa-print me-2"></i>Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Exportación -->
        <div class="modal fade" id="exportacionModal" tabindex="-1" aria-labelledby="exportacionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exportacionModalLabel">Opciones de Exportación de Tabla</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="tipo-export-selector">
                            <h6>Seleccione el tipo de exportación:</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipoExportacion" id="exportCliente" value="cliente" checked>
                                <label class="form-check-label" for="exportCliente">
                                    <strong>Para Cliente</strong> - Información básica
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="tipoExportacion" id="exportInterno" value="interno">
                                <label class="form-check-label" for="exportInterno">
                                    <strong>Uso Interno</strong> - Incluye costos y márgenes
                                </label>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Formato de exportación:</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="exportarTablaActualAExcel()">
                                    <i class="fas fa-file-excel me-2"></i>Exportar a Excel (Vista Actual)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Exportación Completa -->
        <div class="modal fade" id="exportacionCompletaModal" tabindex="-1" aria-labelledby="exportacionCompletaModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exportacionCompletaModalLabel">Guardar Catálogo Completo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Esta función guardará el catálogo completo en un archivo HTML que incluye:
                        </div>
                        <ul>
                            <li>Todos los productos cargados actualmente</li>
                            <li>La configuración de mapeo de columnas</li>
                            <li>Los cálculos automáticos de costos</li>
                            <li>Toda la funcionalidad de la aplicación</li>
                        </ul>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i><strong>Importante:</strong> El archivo generado contendrá todos los datos y podrá abrirse sin necesidad del Excel original.
                        </div>
                        <p class="text-muted">Fecha de generación: <strong id="fechaGeneracion"></strong></p>
                        <p class="text-muted">Productos incluidos: <strong id="cantidadProductos"></strong></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="exportarHTMLCompleto()">
                            <i class="fas fa-download me-2"></i>Descargar Catálogo HTML
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Configuración -->
        <div class="modal fade" id="configuracionModal" tabindex="-1" aria-labelledby="configuracionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="configuracionModalLabel">Configuración del Sistema</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Sección de Seguridad -->
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-shield-alt me-2"></i>Seguridad del Catálogo
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableSecurity" onchange="toggleSecurity()">
                                    <label class="form-check-label" for="enableSecurity">
                                        Activar protección por contraseña
                                    </label>
                                </div>
                                
                                <div id="securitySettings" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>Al activar la seguridad, se requerirá una contraseña para acceder al catálogo.
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Nueva Contraseña</label>
                                                <input type="password" class="form-control" id="newPassword" minlength="6">
                                                <div class="form-text">Mínimo 6 caracteres</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Confirmar Contraseña</label>
                                                <input type="password" class="form-control" id="confirmPassword">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary" onclick="guardarConfiguracionSeguridad()">
                                        <i class="fas fa-save me-2"></i>Guardar Configuración
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Sección de Mapeo de Columnas -->
                        <div class="card mt-3"> 
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-table me-2"></i>Mapeo de Columnas
                            </div>
                            <div class="card-body">
                                <p>El sistema está configurado para usar automáticamente el mapeo estándar del Excel de referencia.</p>
                                <button class="btn btn-info btn-sm" onclick="mostrarMapeoActual()">
                                    <i class="fas fa-eye me-2"></i>Ver Mapeo Actual
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="resetearMapeo()">
                                    <i class="fas fa-undo me-2"></i>Restaurar Mapeo Original
                                </button>
                            </div>
                        </div>

                        <!-- Sección Cargar Datos -->
                        <div class="card mt-3">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-file-excel me-2"></i>Cargar Nuevos Datos
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="dataFileModal" class="form-label">Seleccionar archivo Excel (.xlsx) o CSV (.csv):</label>
                                    <input class="form-control" type="file" id="dataFileModal" accept=".xlsx, .csv">
                                </div>
                                <p class="form-text">Al cargar un nuevo archivo, los datos actuales en el catálogo se reemplazarán. El sistema usará el mapeo de columnas configurado.</p>
                                <div class="alert alert-light-warning mt-2" style="font-size: 0.85rem; background-color: #fff3cd; border-color: #ffeeba; color: #856404;">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Nota sobre persistencia:</strong> Los datos cargados se guardan en el navegador. Si se borran al cerrar el navegador, use el botón <strong>"Guardar Catálogo"</strong> (en la barra de navegación superior) para crear un archivo HTML independiente con todos los datos incrustados. Luego, abra ese archivo HTML descargado.
                                </div>
                                <button class="btn btn-success" onclick="handleFileSelectFromModal()">
                                    <i class="fas fa-upload me-2"></i>Cargar y Reemplazar Datos
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

    <script>
// Función para obtener el logo KOR
function getKorLogo(size = 'medium', showInnovacion = true) {
    const sizes = {
        small: { fontSize: '24px', spacing: '2px' },
        medium: { fontSize: '32px', spacing: '3px' },
        large: { fontSize: '48px', spacing: '4px' },
        xlarge: { fontSize: '64px', spacing: '5px' }
    };
    
    const config = sizes[size] || sizes.medium;
    
    return `
        <div style="display: inline-block; text-align: center;">
            <div style="font-size: ${config.fontSize}; font-weight: 900; letter-spacing: ${config.spacing}; line-height: 1;">
                <span style="color: #FF6B35;">K</span><span style="color: #000;">OR</span>
            </div>
            ${showInnovacion ? `<div style="font-size: ${parseInt(config.fontSize) * 0.3}px; letter-spacing: 3px; color: #666; margin-top: 5px; font-weight: 300;">INNOVACIÓN</div>` : ''}
        </div>
    `;
}

// Variables globales
let productos = [];
let dataTable;
let productoSeleccionadoParaExportar = null;
let isSecurityEnabled = false;
let securityPassword = null;

// ==== NUEVA CONFIGURACIÓN DE API ====
const API_URL = "https://southamerica-east1-lista-precios-2025.cloudfunctions.net/actualizar-precios-v2";

// Variables globales para los ajustes temporales del modal
let margenAdicionalTemporal = 0;
let descuentoClienteTemporal = 0;

// ==== Sistema de Cotización con Bluelytics ====
let cotizacionUSD = 1200; // Valor por defecto
let fechaCotizacionActual = new Date().toISOString().split('T')[0];
let evolucionDataOficial = [];

// Función para cargar datos de evolución del dólar
async function cargarDatosEvolucion() {
    try {
        const response = await fetch('https://api.bluelytics.com.ar/v2/evolution.json');
        if (!response.ok) {
            throw new Error('No se pudo conectar a la API de Bluelytics.');
        }
        const data = await response.json();
        
        // Filtramos para quedarnos solo con el dólar oficial
        evolucionDataOficial = data
            .filter(d => d.source === 'Oficial')
            .sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (evolucionDataOficial.length === 0) {
            throw new Error('La API no devolvió datos para el Dólar Oficial.');
        }

        // Configurar el selector de fecha
        const fechaInput = document.getElementById('fechaCotizacion');
        const hoy = new Date();
        fechaInput.max = toYYYYMMDD(hoy);
        if (evolucionDataOficial.length > 0) {
            fechaInput.min = evolucionDataOficial[0].date;
        }
        fechaInput.value = toYYYYMMDD(hoy);

        // Cargar cotización del día
        buscarCotizacionHistorica(toYYYYMMDD(hoy));

    } catch (error) {
        console.error('Error al cargar datos de cotización:', error);
        mostrarNotificacion('Error al cargar cotización del dólar. Usando valor por defecto.', 'warning');
        actualizarDisplayCotizacion(cotizacionUSD, new Date());
    }
}

// Modificar la función actualizarCotizacion para que actualice la tabla automáticamente
function actualizarCotizacion() {
    const fecha = document.getElementById('fechaCotizacion').value;
    if (fecha) {
        document.getElementById('cotizacionActual').innerHTML = '<div class="cotizacion-spinner"></div>';
        buscarCotizacionHistorica(fecha);
    }
}

// Modificar buscarCotizacionHistorica para forzar actualización
function buscarCotizacionHistorica(fechaStr) {
    const MAX_LOOKBEHIND_DAYS = 7;
    let resultado = null;
    let fechaDeBusqueda = new Date(fechaStr + 'T12:00:00');
    
    for (let i = 0; i <= MAX_LOOKBEHIND_DAYS; i++) {
        const fechaBusquedaStr = toYYYYMMDD(fechaDeBusqueda);
        resultado = evolucionDataOficial.find(d => d.date === fechaBusquedaStr);
        
        if (resultado) break;
        fechaDeBusqueda.setDate(fechaDeBusqueda.getDate() - 1);
    }
    
    if (resultado) {
        cotizacionUSD = resultado.value_sell;
        fechaCotizacionActual = resultado.date;
        actualizarDisplayCotizacion(cotizacionUSD, new Date(resultado.date + 'T12:00:00'));
        
        // Actualizar tabla si existe - FORZAR REDIBUJADO
        if (dataTable) {
            dataTable.rows().invalidate('data').draw(false);
        }
        
        // Actualizar modal si está abierto
        actualizarModalSiEstaAbierto();
        
        // Guardar en localStorage
        localStorage.setItem('korCotizacionUSD', cotizacionUSD);
        localStorage.setItem('korFechaCotizacion', fechaCotizacionActual);
    } else {
        mostrarNotificacion(`No se encontraron datos para la fecha seleccionada.`, 'warning');
    }
}

// Nueva función para actualizar el modal si está abierto
function actualizarModalSiEstaAbierto() {
    const modalElement = document.getElementById('detallesModal');
    if (modalElement && modalElement.classList.contains('show')) {
        // Actualizar valores de cotización en el modal
        const cotizacionModalElem = document.getElementById('cotizacionModalValor');
        if (cotizacionModalElem) {
            cotizacionModalElem.textContent = `$${cotizacionUSD.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        // Actualizar todos los precios en ARS del modal
        document.querySelectorAll('.precio-ars').forEach(elem => {
            const precioUSD = parseFloat(elem.dataset.precioUsd);
            if (!isNaN(precioUSD)) {
                elem.textContent = `AR$ ${(precioUSD * cotizacionUSD).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
        });
        // Actualizar precios con ajustes si los controles están visibles
        if (document.getElementById('margenAdicionalInput')) {
            actualizarPreciosConAjustes();
        }
    }
}

// Función para actualizar cotización desde el modal
function actualizarCotizacionDesdeModal() {
    const fecha = document.getElementById('fechaCotizacionModal').value;
    if (fecha) {
        document.getElementById('cotizacionModalValor').innerHTML = '<div class="cotizacion-spinner" style="width: 16px; height: 16px;"></div>';
        buscarCotizacionHistorica(fecha);
        
        // Sincronizar con el selector principal
        document.getElementById('fechaCotizacion').value = fecha;
    }
}

// Función para actualizar el display de cotización
function actualizarDisplayCotizacion(valor, fecha) {
    const cotizacionElem = document.getElementById('cotizacionActual');
    const cotizacionPanel = document.getElementById('cotizacionPanel');
    
    if (cotizacionElem) {
        cotizacionElem.innerHTML = `$${valor.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
    
    if (cotizacionPanel) {
        cotizacionPanel.style.display = 'flex';
    }
}

// Función auxiliar para formatear fecha
function toYYYYMMDD(date) {
    return date.toISOString().split('T')[0];
}

function formatDate(date) {
    const adjustedDate = new Date(date.toISOString().split('T')[0] + 'T12:00:00');
    return adjustedDate.toLocaleDateString('es-AR', { year: 'numeric', month: 'long', day: 'numeric' });
}

// Función para actualizar precios con margen y descuento
function actualizarPreciosConAjustes() {
    const producto = productoSeleccionadoParaExportar;
    if (!producto) return;
    
    const pvpSinIVA = producto.precio || 0;
    const ivaPct = producto.iva || 0;
    
    // Aplicar margen adicional primero
    const pvpConMargen = pvpSinIVA * (1 + margenAdicionalTemporal / 100);
    
    // Luego aplicar descuento
    const pvpFinalSinIVA = pvpConMargen * (1 - descuentoClienteTemporal / 100);
    const pvpFinalConIVA = pvpFinalSinIVA * (1 + ivaPct / 100);
    
    // Actualizar los valores mostrados
    document.querySelectorAll('.precio-venta-sin-iva').forEach(elem => {
        elem.textContent = `$${pvpFinalSinIVA.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    });
    
    document.querySelectorAll('.precio-venta-con-iva').forEach(elem => {
        elem.textContent = `$${pvpFinalConIVA.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    });
    
    // Actualizar precios en ARS
    document.querySelectorAll('.precio-venta-ars-sin-iva').forEach(elem => {
        elem.textContent = `AR$ ${(pvpFinalSinIVA * cotizacionUSD).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    });
    
    document.querySelectorAll('.precio-venta-ars-con-iva').forEach(elem => {
        elem.textContent = `AR$ ${(pvpFinalConIVA * cotizacionUSD).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    });
    
    // Recalcular márgenes de ganancia para vista interna
    const tipoVistaActual = document.getElementById('detallesModalBody').dataset.tipoVista;
    if (tipoVistaActual === 'interno') {
        actualizarMargenesGanancia(producto, pvpFinalSinIVA, pvpFinalConIVA);
    }
}

// Función para actualizar márgenes de ganancia
function actualizarMargenesGanancia(producto, pvpFinalSinIVA, pvpFinalConIVA) {
    const bonifGralPct = producto.bonificacion || 0;
    const descContadoPct = producto.descuentoContado || 0;
    const bonifFinancPct = producto.bonificacionFinanciacion || 0;
    const ivaPct = producto.iva || 0;
    
    // Costos del revendedor (estos no cambian)
    const pvpOriginalSinIVA = producto.precio || 0;
    const costoContadoSinIVA = pvpOriginalSinIVA * (1 - bonifGralPct/100) * (1 - descContadoPct/100);
    const costoFinancSinIVA = pvpOriginalSinIVA * (1 - bonifFinancPct/100);
    
    const costoContadoConIVA = costoContadoSinIVA * (1 + ivaPct/100);
    const costoFinancConIVA = costoFinancSinIVA * (1 + ivaPct/100);
    
    // Nuevos márgenes con el precio ajustado
    const margenContadoConIVA = pvpFinalConIVA - costoContadoConIVA;
    const porcentajeMargenContado = costoContadoConIVA !== 0 ? (margenContadoConIVA / costoContadoConIVA) * 100 : 0;
    
    const margenFinanciadoConIVA = pvpFinalConIVA - costoFinancConIVA;
    const porcentajeMargenFinanciado = costoFinancConIVA !== 0 ? (margenFinanciadoConIVA / costoFinancConIVA) * 100 : 0;
    
    // Actualizar display de márgenes
    const margenContadoElem = document.getElementById('margen-contado');
    const margenFinanciadoElem = document.getElementById('margen-financiado');
    
    if (margenContadoElem) {
        margenContadoElem.innerHTML = `${porcentajeMargenContado.toFixed(2)}% (Ganancia: $${margenContadoConIVA.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
    }
    
    if (margenFinanciadoElem) {
        margenFinanciadoElem.innerHTML = `${porcentajeMargenFinanciado.toFixed(2)}% (Ganancia: $${margenFinanciadoConIVA.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
    }
}

// Funciones para los controles
function incrementarMargen() {
    margenAdicionalTemporal = Math.min(margenAdicionalTemporal + 5, 200);
    document.getElementById('margenAdicionalInput').value = margenAdicionalTemporal;
    actualizarPreciosConAjustes();
}

function decrementarMargen() {
    margenAdicionalTemporal = Math.max(margenAdicionalTemporal - 5, 0);
    document.getElementById('margenAdicionalInput').value = margenAdicionalTemporal;
    actualizarPreciosConAjustes();
}

function incrementarDescuento() {
    descuentoClienteTemporal = Math.min(descuentoClienteTemporal + 5, 100);
    document.getElementById('descuentoClienteInput').value = descuentoClienteTemporal;
    actualizarPreciosConAjustes();
}

function decrementarDescuento() {
    descuentoClienteTemporal = Math.max(descuentoClienteTemporal - 5, 0);
    document.getElementById('descuentoClienteInput').value = descuentoClienteTemporal;
    actualizarPreciosConAjustes();
}

function cambiarMargenManual() {
    const valor = parseFloat(document.getElementById('margenAdicionalInput').value) || 0;
    margenAdicionalTemporal = Math.max(0, Math.min(200, valor));
    document.getElementById('margenAdicionalInput').value = margenAdicionalTemporal;
    actualizarPreciosConAjustes();
}

function cambiarDescuentoManual() {
    const valor = parseFloat(document.getElementById('descuentoClienteInput').value) || 0;
    descuentoClienteTemporal = Math.max(0, Math.min(100, valor));
    document.getElementById('descuentoClienteInput').value = descuentoClienteTemporal;
    actualizarPreciosConAjustes();
}

function resetearAjustes() {
    margenAdicionalTemporal = 0;
    descuentoClienteTemporal = 0;
    document.getElementById('margenAdicionalInput').value = 0;
    document.getElementById('descuentoClienteInput').value = 0;
    actualizarPreciosConAjustes();
}

// Configuración de almacenamiento
const STORAGE_KEYS = {
    products: 'catalogoKorProducts',
    mapping: 'catalogoKorColumnMapping',
    security: 'catalogoKorSecurity'
};

// ==== Mapeo de columnas ====
const DEFAULT_MAPPING = {
  familia:              'Familia',
  modelo:               'Modelo',
  marca:                'Marca',
  descripcion:          'Descripción',
  caracteristicas:      'Características',
  potencia:             'Potencia',
  tension:              'Tensión',
  motor:                'Motor',
  arranque:             'Arranque',
  combustible:          'Combustible',
  cabina:               'Cabina',
  tta:                  'TTA Incluido',
  peso:                 'Peso (kg)',
  dimensiones:          'Dimensiones',
  stock:                'Stock',
  urlPdf:               'URL PDF',
  precio:                   'Precio USD sin IVA',
  iva:                      'IVA %',
  precioConIVA:             'Precio USD con IVA',
  bonificacion:             'Bonificación %',
  descuentoContado:         'Descuento Contado %',
  bonificacionFinanciacion: 'Bonif. Financiación %',
  financiacion:             'Plan Financiación',
  precioCompra:         'Precio Compra',
  precioContadoFinal:   'Precio Compra Contado',
  precioFinanciado:     'Costo Financiado',
  imagen1: 'Instagram_Feed_URL_1',
  imagen2: 'Instagram_Feed_URL_2',
  imagen3: 'Instagram_Feed_URL_3',
  imagen4: 'Instagram_Feed_URL_4',
  imagen5: 'Instagram_Feed_URL_5'
};

// Inicialización
$(document).ready(function() {
    $('#korLogoNav').html(getKorLogo('small', false));
    $('#korLogoFooter').html(getKorLogo('large', true));
    
    loadSecurityConfig();
    
    const savedCotizacion = localStorage.getItem('korCotizacionUSD');
    if (savedCotizacion) {
        cotizacionUSD = parseFloat(savedCotizacion);
    }
    
    // Cargar datos de evolución del dólar y LUEGO cargar productos desde la API
    cargarDatosEvolucion().then(() => {
        cargarProductosDesdeAPI(); // <<<--- NUEVA LLAMADA
    });
    
    initializeEmptyTable();
    
    // $('#dataFileModal').on('change', handleFileSelect); // <<<--- LÍNEA COMENTADA/ELIMINADA
    
    populateStaticFilters();
});

// Guardar y cargar productos
function saveProducts() {
    if (productos.length > 0) {
        localStorage.setItem(STORAGE_KEYS.products, JSON.stringify(productos));
    }
}

function loadSavedProducts() {
    const savedProducts = localStorage.getItem(STORAGE_KEYS.products);
    if (savedProducts) {
        try {
            productos = JSON.parse(savedProducts);
            console.log('Productos cargados desde localStorage:', productos.length);
        } catch (e) {
            console.error('Error al cargar productos guardados:', e);
            productos = [];
        }
    }
}

// Funciones de seguridad
function loadSecurityConfig() {
    const security = localStorage.getItem(STORAGE_KEYS.security);
    if (security) {
        const config = JSON.parse(security);
        isSecurityEnabled = config.enabled;
        securityPassword = config.password;
        updateSecurityStatus();
        $('#enableSecurity').prop('checked', isSecurityEnabled);
        if (isSecurityEnabled) {
            $('#securitySettings').show();
        }
    }
}

function toggleSecurity() {
    const isChecked = $('#enableSecurity').is(':checked');
    if (isChecked) {
        $('#securitySettings').slideDown();
    } else {
        $('#securitySettings').slideUp();
        isSecurityEnabled = false;
        securityPassword = null;
        saveSecurityConfig();
        updateSecurityStatus();
    }
}

function guardarConfiguracionSeguridad() {
    const newPass = $('#newPassword').val();
    const confirmPass = $('#confirmPassword').val();
    
    if (!newPass || newPass.length < 6) {
        mostrarNotificacion('La contraseña debe tener al menos 6 caracteres', 'warning');
        return;
    }
    
    if (newPass !== confirmPass) {
        mostrarNotificacion('Las contraseñas no coinciden', 'danger');
        return;
    }
    
    isSecurityEnabled = true;
    securityPassword = hashPassword(newPass);
    saveSecurityConfig();
    updateSecurityStatus();
    
    $('#newPassword').val('');
    $('#confirmPassword').val('');
    
    mostrarNotificacion('Configuración de seguridad guardada correctamente', 'success');
}

function saveSecurityConfig() {
    const config = {
        enabled: isSecurityEnabled,
        password: securityPassword
    };
    localStorage.setItem(STORAGE_KEYS.security, JSON.stringify(config));
}

function updateSecurityStatus() {
    const statusEl = $('#securityStatus');
    if (isSecurityEnabled) {
        statusEl.removeClass('security-disabled').addClass('security-enabled');
        statusEl.html('<i class="fas fa-lock me-1"></i>Protegido');
    } else {
        statusEl.removeClass('security-enabled').addClass('security-disabled');
        statusEl.html('<i class="fas fa-unlock me-1"></i>Sin Protección');
    }
}

function hashPassword(password) {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash.toString();
}

// Función para mostrar el mapeo actual
function mostrarMapeoActual() {
    const mapping = JSON.parse(localStorage.getItem(STORAGE_KEYS.mapping) || '{}');
    let mappingHtml = '<div class="alert alert-info"><h6>Mapeo de columnas actual:</h6><ul class="mb-0">';
    
    for (const [campo, columna] of Object.entries(mapping)) {
        mappingHtml += `<li><strong>${campo}:</strong> ${columna}</li>`;
    }
    
    mappingHtml += '</ul></div>';
    
    mostrarNotificacion(mappingHtml, 'info', 10000);
}

// Función para resetear el mapeo
function resetearMapeo() {
    if (confirm('¿Está seguro de restaurar el mapeo original? Esto sobrescribirá la configuración actual.')) {
        localStorage.setItem(STORAGE_KEYS.mapping, JSON.stringify(DEFAULT_MAPPING));
        mostrarNotificacion('Mapeo restaurado al original', 'success');
    }
}

// Función para exportar HTML completo con datos embebidos
function exportarHTMLCompleto() {
    $('#exportacionCompletaModal').modal('hide');
    
    setTimeout(() => {
        mostrarCargando();
        
        try {
            // Obtener el HTML actual
            let htmlContent = document.documentElement.outerHTML;
            
            // Preparar los datos para embeber
            const catalogoData = {
                productos: productos,
                mapping: JSON.parse(localStorage.getItem(STORAGE_KEYS.mapping) || '{}'),
                security: isSecurityEnabled ? {
                    enabled: true,
                    password: securityPassword
                } : { enabled: false },
                cotizacion: {
                    valor: cotizacionUSD,
                    fecha: fechaCotizacionActual
                },
                fechaGeneracion: new Date().toISOString(),
                version: "5.0"
            };
            
            // Script que se ejecutará en el archivo exportado
            const scriptEmbebido = `
<script id="datosEmbebidosCatalogo">
// ============================================
// DATOS EMBEBIDOS DEL CATÁLOGO KOR V5.0
// Generado: ${new Date().toLocaleString('es-AR')}
// Productos: ${productos.length}
// ============================================

// Datos completos del catálogo
window.CATALOGO_KOR_EMBEBIDO = ${JSON.stringify(catalogoData)};

// Función para inicializar el catálogo embebido
(function() {
    console.log('🚀 Iniciando carga de catálogo embebido V5.0...');
    
    function cargarDatosEmbebidos() {
        try {
            if (!window.CATALOGO_KOR_EMBEBIDO) {
                console.error('❌ No se encontraron datos embebidos');
                return;
            }
            
            const datos = window.CATALOGO_KOR_EMBEBIDO;
            console.log('📦 Datos encontrados:', {
                productos: datos.productos ? datos.productos.length : 0,
                mapping: datos.mapping ? 'Sí' : 'No',
                security: datos.security ? (datos.security.enabled ? 'Activada' : 'Desactivada') : 'No configurada',
                cotizacion: datos.cotizacion ? 'USD ' + datos.cotizacion.valor : 'No configurada'
            });
            
            // Verificar si es primera carga
            const productosActuales = localStorage.getItem('catalogoKorProducts');
            const primeraVez = !productosActuales || productosActuales === '[]';
            
            if (primeraVez) {
                console.log('✨ Primera carga detectada - Instalando catálogo...');
                
                // 1. Cargar productos
                if (datos.productos && datos.productos.length > 0) {
                    localStorage.setItem('catalogoKorProducts', JSON.stringify(datos.productos));
                    console.log('✅ Productos cargados:', datos.productos.length);
                }
                
                // 2. Cargar mapeo
                if (datos.mapping) {
                    localStorage.setItem('catalogoKorColumnMapping', JSON.stringify(datos.mapping));
                    console.log('✅ Mapeo de columnas cargado');
                }
                
                // 3. Cargar configuración de seguridad
                if (datos.security) {
                    localStorage.setItem('catalogoKorSecurity', JSON.stringify(datos.security));
                    console.log('✅ Configuración de seguridad cargada');
                }
                
                // 4. Cargar cotización
                if (datos.cotizacion) {
                    localStorage.setItem('korCotizacionUSD', datos.cotizacion.valor);
                    localStorage.setItem('korFechaCotizacion', datos.cotizacion.fecha);
                    console.log('✅ Cotización cargada: USD', datos.cotizacion.valor);
                }
                
                console.log('🎉 Catálogo instalado exitosamente');
                
                // Si hay seguridad activada, recargar para solicitar contraseña
                if (datos.security && datos.security.enabled) {
                    console.log('🔒 Seguridad activada - Recargando...');
                    setTimeout(() => location.reload(), 1000);
                }
                
            } else {
                console.log('📋 Ya existen datos. Para reemplazarlos, use la función reinstalarCatalogo()');
            }
            
        } catch (error) {
            console.error('❌ Error al cargar datos:', error);
        }
    }
    
    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', cargarDatosEmbebidos);
    } else {
        cargarDatosEmbebidos();
    }
})();

// Función auxiliar para reinstalar
window.reinstalarCatalogo = function() {
    if (confirm('¿Desea reinstalar el catálogo? Esto borrará los datos actuales.')) {
        localStorage.removeItem('catalogoKorProducts');
        localStorage.removeItem('catalogoKorColumnMapping');
        localStorage.removeItem('catalogoKorSecurity');
        localStorage.removeItem('korCotizacionUSD');
        localStorage.removeItem('korFechaCotizacion');
        location.reload();
    }
};

console.log('💡 Tip: Si tiene problemas, ejecute reinstalarCatalogo() en la consola');
<\/script>`;

            // Limpiar el HTML
            htmlContent = htmlContent.replace(/<script[^>]*id="datosEmbebidos[^"]*"[^>]*>[\s\S]*?<\/script>/gi, '');
            
            // Insertar el nuevo script
            htmlContent = htmlContent.replace('</body>', scriptEmbebido + '\n</body>');
            
            // Agregar meta tags
            if (!htmlContent.includes('name="catalogo-kor-version"')) {
                htmlContent = htmlContent.replace('</head>', 
                    `<meta name="catalogo-kor-version" content="5.0">
<meta name="catalogo-fecha" content="${new Date().toISOString()}">
<meta name="catalogo-productos" content="${productos.length}">
<meta name="catalogo-cotizacion" content="${cotizacionUSD}">
</head>`);
            }
            
            // Crear el blob y descargar
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            
            const fecha = new Date();
            const timestamp = fecha.toISOString().replace(/[:.]/g, '-').slice(0, -5);
            link.download = `Catalogo_KOR_${timestamp}.html`;
            
            document.body.appendChild(link);
            link.click();
            
            setTimeout(() => {
                try {
                    if (document.body.contains(link)) {
                        document.body.removeChild(link);
                    }
                    URL.revokeObjectURL(url);
                } catch (cleanupError) {
                    console.warn("Error durante la limpieza post-descarga:", cleanupError);
                } finally {
                    ocultarCargando();
                    mostrarNotificacion(
                        'Catálogo exportado exitosamente. El archivo contiene todos los datos y puede abrirse sin necesidad del Excel original.', 
                        'success'
                    );
                }
            }, 300);

        } catch (error) {
            console.error('Error al preparar la exportación:', error);
            ocultarCargando(); 
            mostrarNotificacion('Error al preparar la exportación del catálogo: ' + error.message, 'danger');
        }
    }, 500);
}

// También actualizar la función que muestra el modal de exportación
function mostrarModalExportacionCompleta() {
    $('#fechaGeneracion').text(new Date().toLocaleString('es-AR'));
    $('#cantidadProductos').text(productos.length);
    $('#exportacionCompletaModal').modal('show');
}

function populateStaticFilters() {
    const combustibles = ["Nafta", "Diesel", "Gas", "Nafta/Gas", "Eléctrico"];
    const cabinas = ["Abierto", "Silent", "Ultra Silent", "Sin Cabina", "Insonorizada"];
    const unidadesPotencia = ["W", "KW", "KVA", "HP", "CC"];

    const filtroCombustible = $('#filtroCombustible');
    combustibles.forEach(c => filtroCombustible.append(`<option value="${c}">${c}</option>`));

    const filtroCabina = $('#filtroCabina');
    cabinas.forEach(c => filtroCabina.append(`<option value="${c}">${c}</option>`));
    
    const unidadPotenciaSelect = $('#unidadPotencia');
    unidadesPotencia.forEach(u => unidadPotenciaSelect.append(`<option value="${u}">${u}</option>`));
}

// Sistema de conversión de unidades de potencia
const CONVERSIONES_POTENCIA = {
    W: 1,
    KW: 1000,
    KVA: 1000 * 0.8,
    HP: 745.7,
    CV: 735.5,
    CC: 0.746
};

function normalizarPotencia(valor, unidad) {
    if (!valor || valor === 0) return 0;
    
    const unidadUpper = String(unidad).toUpperCase().trim();
    
    for (const [key, factor] of Object.entries(CONVERSIONES_POTENCIA)) {
        if (unidadUpper.includes(key)) {
            return valor * factor;
        }
    }
    
    return valor;
}

function formatearPotenciaInteligente(potenciaWatts) {
    if (!potenciaWatts || potenciaWatts === 0) return '-';
    
    if (potenciaWatts >= 1000) {
        const kw = potenciaWatts / 1000;
        if (kw % 1 === 0 || kw.toFixed(1) == kw.toFixed(0)) {
            return `${kw.toFixed(0)} KW`;
        } else {
            return `${kw.toFixed(1)} KW`;
        }
    }
    
    return `${Math.round(potenciaWatts)} W`;
}

function processPotenciaAvanzada(potenciaRaw) {
    if (!potenciaRaw || potenciaRaw.toString().trim() === '') {
        return { 
            valor: 0, 
            unidad: '', 
            valorNormalizado: 0,
            textoOriginal: '',
            textoFormateado: '-'
        };
    }
    
    const potenciaStr = String(potenciaRaw).trim();
    
    // Buscar números y unidades
    const match = potenciaStr.match(/^([\d.,]+)\s*([A-Za-z.]+)?/);
    
    if (match) {
        const valor = parseFloat(match[1].replace(',', '.'));
        const unidad = (match[2] || 'W').trim().toUpperCase();
        const valorNormalizado = normalizarPotencia(valor, unidad);
        
        return {
            valor: isNaN(valor) ? 0 : valor,
            unidad: unidad,
            valorNormalizado: valorNormalizado,
            textoOriginal: potenciaStr,
            textoFormateado: formatearPotenciaInteligente(valorNormalizado)
        };
    } else {
        // Casos especiales
        const numeroMatch = potenciaStr.match(/(\d+)/);
        if (numeroMatch) {
            const valor = parseFloat(numeroMatch[1]);
            return {
                valor: valor,
                unidad: potenciaStr.replace(numeroMatch[1], '').trim(),
                valorNormalizado: valor,
                textoOriginal: potenciaStr,
                textoFormateado: potenciaStr
            };
        }
        
        return {
            valor: 0,
            unidad: potenciaStr,
            valorNormalizado: 0,
            textoOriginal: potenciaStr,
            textoFormateado: potenciaStr
        };
    }
}

function processImportedData(dataRows) {
    return dataRows.map(row => {
        const potenciaData = processPotenciaAvanzada(row.Potencia);
        
        const producto = {
            sku: row.SKU,
            familia: row.Familia,
            modelo: row.Modelo,
            marca: row.Marca,
            precio: parseFloat(row.Precio_USD_sin_IVA) || 0,
            iva: parseFloat(row['IVA_%']) || 10.5,
            combustible: row.Combustible,
            stock: row.Stock,
            potencia: potenciaData.valor,
            unidadPotencia: potenciaData.unidad,
            potenciaCompleta: potenciaData.textoOriginal,
            potenciaNormalizada: potenciaData.valorNormalizado,
            potenciaFormateada: potenciaData.textoFormateado,
            motor: row.Motor,
            arranque: row.Arranque,
            cabina: row.Cabina,
            tta: row.TTA_Incluido,
            peso: parseFloat(row['Peso_(kg)']) || 0,
            dimensiones: row.Dimensiones,
            descripcion: row.Descripción,
            caracteristicas: row.Características,
            urlPdf: row.URL_PDF,
            bonificacion: parseFloat(row['Bonificación_%']) || 0,
            descuentoContado: parseFloat(row['Descuento_Contado_%']) || 0,
            bonificacionFinanciacion: parseFloat(row['Bonif_Financiación_%']) || 0,
            financiacion: row.Plan_Financiación,
            precioCompraSinIVA: parseFloat(row.Precio_Compra) || 0,
            imagenes: [
                row.Instagram_Feed_URL_1, row.Instagram_Feed_URL_2, row.Instagram_Feed_URL_3, row.Instagram_Feed_URL_4, row.Instagram_Feed_URL_5, row.Instagram_Feed_URL_6, row.Instagram_Feed_URL_7, row.Instagram_Feed_URL_8, row.Instagram_Feed_URL_9, row.Instagram_Feed_URL_10, row.Instagram_Feed_URL_11,
                row.Instagram_Story_URL_1, row.Instagram_Story_URL_2, row.Instagram_Story_URL_3, row.Instagram_Story_URL_4, row.Instagram_Story_URL_5,
                row.MercadoLibre_URL_1, row.MercadoLibre_URL_2, row.MercadoLibre_URL_3, row.MercadoLibre_URL_4, row.MercadoLibre_URL_5,
                row.Web_Generica_URL_1, row.Web_Generica_URL_2, row.Web_Generica_URL_3, row.Web_Generica_URL_4, row.Web_Generica_URL_5
            ].filter(Boolean)
        };
        
        producto.imagenes = [...new Set(producto.imagenes)];
        return producto;
    });
}

function initializeEmptyTable() {
    if (dataTable) {
        dataTable.clear().draw();
    } else {
        dataTable = $('#productosTable').DataTable({
            data: [],
            columns: [
                { 
                    data: 'imagenes', 
                    render: function(data, type, row) {
                        if (type === 'display') {
                            if (data && data.length > 0 && data[0]) {
                                return `<img src="${data[0]}" alt="Producto" style="width: 60px; height: 60px; object-fit: contain; border-radius: 4px; border: 1px solid #ddd;" onerror="this.onerror=null; this.src='https://placehold.co/60x60/EEE/CCC?text=Error'; this.alt='Error al cargar imagen';">`;
                            }
                            return '<div style="width: 60px; height: 60px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #aaa; font-size: 10px; text-align:center; border: 1px solid #ddd;">Sin Imagen</div>';
                        }
                        return data && data.length > 0 ? data[0] : 'Sin Imagen';
                    },
                    orderable: false,
                    searchable: false 
                },
                { data: 'modelo', render: data => `<strong>${data || '-'}</strong>` },
                { data: 'marca', defaultContent: '-' },
                { 
                    data: 'potenciaNormalizada',
                    render: function(data, type, row) {
                        if (type === 'display') {
                            return `<strong>${row.potenciaFormateada || row.potenciaCompleta || '-'}</strong>`;
                        } else if (type === 'filter') {
                            return `${row.potenciaCompleta} ${row.potenciaFormateada}`;
                        }
                        return row.potenciaNormalizada || 0;
                    },
                    defaultContent: '-'
                },
                { data: 'motor', defaultContent: '-' },
                { data: 'combustible', render: data => {
                    if (!data) return '-';
                    let color = getCombustibleColor(data);
                    return `<span class="badge bg-${color}">${data}</span>`;
                  }
                },
                { data: 'cabina', defaultContent: '-' },
                { data: 'tta', render: data => `<span class="badge bg-${(data === 'Si' || data === 'SI' || data === 'si') ? 'success' : 'secondary'}">${data || 'No'}</span>` },
                { data: 'precio', render: data => data === 0 ? 'Consultar' : `$${(data || 0).toLocaleString('es-AR')}` },
                {
                    data: 'precio',
                    title: 'Precio ARS',
                    render: data =>
                        data === 0
                            ? 'Consultar'
                            : `AR$ ${(data * cotizacionUSD).toLocaleString('es-AR')}`
                },
                { data: 'stock', render: data => {
                    let color = getStockColor(data);
                    return `<span class="badge bg-${color} badge-stock">${data || 'Consultar'}</span>`;
                  }
                },
                { data: null, orderable: false, responsivePriority: 1, render: function(data, type, row) {
                        const productIndex = productos.findIndex(p => p === row);
                        return `
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary btn-sm" title="Ver Detalles (Cliente)" onclick="verDetalles(${productIndex}, 'cliente')">
                                    <i class="fas fa-eye"></i> Cliente
                                </button>
                                <button class="btn btn-outline-danger btn-sm" title="Ver Detalles (Interno con Costos)" onclick="verDetalles(${productIndex}, 'interno')">
                                    <i class="fas fa-dollar-sign"></i> Costos
                                </button>
                            </div>`;
                    }
                }
            ],
            language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' },
            pageLength: 25,
            responsive: true,
            dom: 'Bfrltip',
            buttons: []
        });
    }
    $('#totalProductos, #totalFamilias, #totalStock, #totalSinStock').text('0');
    $('#filtroFamilia').empty().append('<option value="">Todas las familias</option>');
    $('#filtroMarca').empty().append('<option value="">Todas las marcas</option>');
}

function handleFileSelectFromModal() {
    mostrarNotificacion('La carga de archivos ha sido reemplazada por la conexión directa a la base de datos.', 'info');
}

function handleFileSelect(event) {
     mostrarNotificacion('La carga de archivos ha sido reemplazada por la conexión directa a la base de datos.', 'info');
}

async function cargarProductosDesdeAPI() {
    mostrarCargando();
    try {
        const response = await fetch(API_URL);
        if (!response.ok) {
            throw new Error(`Error de red: ${response.status} - ${response.statusText}`);
        }
        const datosSQL = await response.json();

        if (!Array.isArray(datosSQL)) {
            throw new Error("La respuesta de la API no es un formato válido.");
        }

        productos = processImportedData(datosSQL);
        saveProducts();
        finalizeDataLoading();

    } catch (error) {
        console.error("Error al cargar productos desde la API:", error);
        mostrarNotificacion(`No se pudieron cargar los datos desde la base de datos. Verifique la conexión y el servicio.`, 'danger');
        ocultarCargando();
    }
}

function finalizeDataLoading() {
    if (dataTable) { dataTable.destroy(); }
    cargarFiltrosDinamicos();
    inicializarTablaConDatos();
    actualizarEstadisticas();
    ocultarCargando();
    mostrarNotificacion('Datos cargados correctamente.', 'success');
}

function cargarFiltrosDinamicos() {
    const familias = [...new Set(productos.map(p => p.familia).filter(Boolean))].sort();
    const filtroFamilia = $('#filtroFamilia');
    filtroFamilia.empty().append('<option value="">Todas las familias</option>');
    familias.forEach(fam => filtroFamilia.append(`<option value="${fam}">${fam}</option>`));

    const marcas = [...new Set(productos.map(p => p.marca).filter(Boolean))].sort();
    const filtroMarca = $('#filtroMarca');
    filtroMarca.empty().append('<option value="">Todas las marcas</option>');
    marcas.forEach(marca => filtroMarca.append(`<option value="${marca}">${marca}</option>`));
}

function inicializarTablaConDatos() {
    dataTable = $('#productosTable').DataTable({
        data: productos,
        columns: [
            { 
                data: 'imagenes', 
                render: function(data, type, row) {
                    if (type === 'display') {
                        if (data && data.length > 0 && data[0]) {
                            return `<img src="${data[0]}" alt="Producto" style="width: 60px; height: 60px; object-fit: contain; border-radius: 4px; border: 1px solid #ddd;" onerror="this.onerror=null; this.src='https://placehold.co/60x60/EEE/CCC?text=Error'; this.alt='Error al cargar imagen';">`;
                        }
                        return '<div style="width: 60px; height: 60px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #aaa; font-size: 10px; text-align:center; border: 1px solid #ddd;">Sin Imagen</div>';
                    }
                    return data && data.length > 0 ? data[0] : 'Sin Imagen';
                },
                orderable: false,
                searchable: false
            },
            { data: 'modelo', render: data => `<strong>${data || '-'}</strong>` },
            { data: 'marca', defaultContent: '-' },
            { 
                data: 'potenciaNormalizada',
                render: function(data, type, row) {
                    if (type === 'display') {
                        return `<strong>${row.potenciaFormateada || row.potenciaCompleta || '-'}</strong>`;
                    } else if (type === 'filter') {
                        return `${row.potenciaCompleta} ${row.potenciaFormateada}`;
                    }
                    return row.potenciaNormalizada || 0;
                },
                defaultContent: '-'
            },
            { data: 'motor', defaultContent: '-' },
            { data: 'combustible', render: data => {
                if (!data) return '-';
                let color = getCombustibleColor(data);
                return `<span class="badge bg-${color}">${data}</span>`;
                }
            },
            { data: 'cabina', defaultContent: '-' },
            { data: 'tta', render: data => `<span class="badge bg-${(data === 'Si' || data === 'SI' || data === 'si') ? 'success' : 'secondary'}">${data || 'No'}</span>` },
            { data: 'precio', render: data => data === 0 ? 'Consultar' : `$${(data || 0).toLocaleString('es-AR')}` },
            {
                data: 'precio',
                title: 'Precio ARS',
                render: data =>
                    data === 0
                        ? 'Consultar'
                        : `AR$ ${(data * cotizacionUSD).toLocaleString('es-AR')}`
            },
            { data: 'stock', render: data => {
                let color = getStockColor(data);
                return `<span class="badge bg-${color} badge-stock">${data || 'Consultar'}</span>`;
                }
            },
                { data: null, orderable: false, responsivePriority: 1, render: function(data, type, row) {
                        const productIndex = productos.findIndex(p => p === row);
                        return `
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary btn-sm" title="Ver Detalles (Cliente)" onclick="verDetalles(${productIndex}, 'cliente')">
                                    <i class="fas fa-eye"></i> Cliente
                                </button>
                                <button class="btn btn-outline-danger btn-sm" title="Ver Detalles (Interno con Costos)" onclick="verDetalles(${productIndex}, 'interno')">
                                    <i class="fas fa-dollar-sign"></i> Costos
                                </button>
                            </div>`;
                    }
                }
        ],
        language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' },
        pageLength: 25,
        responsive: true,
        destroy: true,
        dom: 'Bfrltip',
        buttons: []
    });
}

function aplicarFiltros() {
    mostrarCargando();
    
    setTimeout(() => {
        const familia = $('#filtroFamilia').val();
        const marca = $('#filtroMarca').val();
        const combustible = $('#filtroCombustible').val();
        const stock = $('#filtroStock').val();
        const cabina = $('#filtroCabina').val();
        const tta = $('#filtroTTA').val();
        const precioMin = parseFloat($('#precioMin').val()) || 0;
        const precioMax = parseFloat($('#precioMax').val()) || Infinity;
        const potenciaMin = parseFloat($('#potenciaMin').val()) || 0;
        const unidadPotencia = $('#unidadPotencia').val();
        const busqueda = $('#busquedaTexto').val().toLowerCase().trim();

        $.fn.dataTable.ext.search.pop();
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
            const producto = productos[dataIndex];
            if (!producto) return false;

            if (familia && producto.familia !== familia) return false;
            if (marca && producto.marca !== marca) return false;
            if (combustible && producto.combustible !== combustible) return false;
            if (stock && producto.stock !== stock) return false;
            if (cabina && producto.cabina !== cabina) return false;
            if (tta && producto.tta !== tta) return false;
            
            const precioProducto = producto.precio || 0;
            if (precioProducto < precioMin || precioProducto > precioMax) return false;
            
            if (potenciaMin > 0) {
                let potenciaMinWatts = potenciaMin;
                
                if (unidadPotencia) {
                    potenciaMinWatts = normalizarPotencia(potenciaMin, unidadPotencia);
                }
                
                if (producto.potenciaNormalizada < potenciaMinWatts) return false;
            }
            
            if (busqueda) {
                const textoProducto = (
                    (producto.modelo || '') + ' ' + 
                    (producto.descripcion || '') + ' ' +
                    (producto.motor || '') + ' ' +
                    (producto.familia || '') + ' ' +
                    (producto.marca || '') + ' ' +
                    (producto.caracteristicas || '') + ' ' +
                    (producto.potenciaCompleta || '') + ' ' +
                    (producto.potenciaFormateada || '')
                ).toLowerCase();
                if (!textoProducto.includes(busqueda)) return false;
            }
            return true;
        });

        dataTable.draw();
        actualizarEstadisticasFiltradas();
        ocultarCargando();
    }, 250);
}

function actualizarEstadisticasFiltradas() {
    const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
    $('#totalProductos').text(filteredData.length);
    if (filteredData.length > 0) {
        $('#totalFamilias').text([...new Set(filteredData.map(p => p.familia))].length);
        $('#totalStock').text(filteredData.filter(p => p.stock === 'Disponible').length);
        $('#totalSinStock').text(filteredData.filter(p => p.stock === 'Sin Stock' || p.stock === 'Consultar').length);
    } else {
        $('#totalFamilias, #totalStock, #totalSinStock').text('0');
    }
}

function limpiarFiltros() {
    $('#filtroFamilia, #filtroMarca, #filtroCombustible, #filtroStock, #filtroCabina, #filtroTTA, #unidadPotencia').val('');
    $('#precioMin, #precioMax, #potenciaMin, #busquedaTexto').val('');
    $.fn.dataTable.ext.search.pop();
    dataTable.search('').columns().search('').draw();
    actualizarEstadisticas();
}

function verDetalles(index, tipoVista = 'cliente') {
    // Resetear ajustes temporales
    margenAdicionalTemporal = 0;
    descuentoClienteTemporal = 0;
    
    productoSeleccionadoParaExportar = productos[index];
    if (!productoSeleccionadoParaExportar) {
        mostrarNotificacion("Error: No se pudo encontrar el producto.", "danger");
        return;
    }

    const producto = productoSeleccionadoParaExportar;
    
    // Interpretación de precios y costos
    const pvpSinIVA = producto.precio || 0;
    const ivaPct    = producto.iva   || 0;
    const pvpConIVA = pvpSinIVA * (1 + ivaPct / 100);

    // Condiciones de compra
    const bonifGralPct       = producto.bonificacion            || 0;
    const descContadoPct     = producto.descuentoContado        || 0;
    const bonifFinancPct     = producto.bonificacionFinanciacion|| 0;

    // Costos del revendedor
    const costoContadoSinIVA   = pvpSinIVA * (1 - bonifGralPct/100) * (1 - descContadoPct/100);
    const costoFinancSinIVA    = pvpSinIVA * (1 - bonifFinancPct/100);

    const costoContadoConIVA = costoContadoSinIVA * (1 + ivaPct/100);
    const costoFinancConIVA  = costoFinancSinIVA  * (1 + ivaPct/100);

    let rentabilidadHtml = '';
    if (tipoVista === 'interno') {
        const margenContadoConIVA = pvpConIVA - costoContadoConIVA;
        const porcentajeMargenContado = costoContadoConIVA !== 0 ? (margenContadoConIVA / costoContadoConIVA) * 100 : 0;
        
        const margenFinanciadoConIVA = pvpConIVA - costoFinancConIVA;
        const porcentajeMargenFinanciado = costoFinancConIVA !== 0 ? (margenFinanciadoConIVA / costoFinancConIVA) * 100 : 0;

        // Se utilizan IDs para actualizar dinámicamente
        rentabilidadHtml = `
            <tr><td colspan="3" class="bg-light text-dark mt-2"><strong>SUS MÁRGENES DE GANANCIA</strong></td></tr>
            <tr>
                <td>Contado:</td>
                <td colspan="2" id="margen-contado">${porcentajeMargenContado.toFixed(2)}% (Ganancia: $${margenContadoConIVA.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})</td>
            </tr>
            <tr>
                <td>Financiado:</td>
                <td colspan="2" id="margen-financiado">${porcentajeMargenFinanciado.toFixed(2)}% (Ganancia: $${margenFinanciadoConIVA.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})</td>
            </tr>
        `;
    }
    
    let controlesAjusteHtml = `
        <div class="controles-ajuste-precios mt-3">
            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #ddd;">
                <h6 class="text-center mb-3" style="color: #FF6B35; font-weight: 700;">
                    <i class="fas fa-calculator me-2"></i>Ajustes de Precio
                </h6>
                
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label small fw-bold">
                            <i class="fas fa-chart-line me-1" style="color: #27ae60;"></i>Margen Adicional
                        </label>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-success" type="button" onclick="decrementarMargen()">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="form-control text-center" id="margenAdicionalInput" 
                                   value="0" min="0" max="200" step="5" onchange="cambiarMargenManual()">
                            <span class="input-group-text">%</span>
                            <button class="btn btn-outline-success" type="button" onclick="incrementarMargen()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="form-text">Aumenta el precio base</div>
                    </div>
                    
                    <div class="col-12 col-md-6">
                        <label class="form-label small fw-bold">
                            <i class="fas fa-percentage me-1" style="color: #e74c3c;"></i>Descuento Cliente
                        </label>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-danger" type="button" onclick="decrementarDescuento()">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="form-control text-center" id="descuentoClienteInput" 
                                   value="0" min="0" max="100" step="5" onchange="cambiarDescuentoManual()">
                            <span class="input-group-text">%</span>
                            <button class="btn btn-outline-danger" type="button" onclick="incrementarDescuento()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="form-text">Reduce el precio final</div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-sm btn-secondary" onclick="resetearAjustes()">
                        <i class="fas fa-undo me-1"></i>Restablecer Precios
                    </button>
                </div>
                
                <div class="alert alert-info mt-3 mb-0 py-2 px-3" style="font-size: 0.85rem;">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Fórmula:</strong> Precio Final = Base × (1 + Margen%) × (1 - Descuento%)
                </div>
            </div>
        </div>
    `;

    let carouselHtml = '';
    if (producto.imagenes && producto.imagenes.length > 0) {
        carouselHtml = `
            <div class="product-image-container mb-3">
                <div id="productImageCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        ${producto.imagenes.map((url, i) => `
                            <button type="button" data-bs-target="#productImageCarousel" data-bs-slide-to="${i}" 
                                class="${i === 0 ? 'active' : ''}" aria-current="${i === 0 ? 'true' : 'false'}" 
                                aria-label="Imagen ${i + 1}" 
                                style="width: 8px; height: 8px; border-radius: 50%;"></button>
                        `).join('')}
                    </div>
                    <div class="carousel-inner rounded" style="background: #f5f5f5;">
                        ${producto.imagenes.map((url, i) => `
                            <div class="carousel-item ${i === 0 ? 'active' : ''}">
                                <div style="height: 250px; display: flex; align-items: center; justify-content: center; padding: 10px;">
                                    <img src="${url}" class="d-block" style="max-width: 100%; max-height: 100%; object-fit: contain;" 
                                         alt="Imagen de ${producto.modelo || 'producto'} ${i + 1}" 
                                         onerror="this.src='https://placehold.co/300x200/EEE/999?text=Sin+imagen'; this.alt='Imagen no disponible'">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${producto.imagenes.length > 1 ? `
                        <button class="carousel-control-prev" type="button" data-bs-target="#productImageCarousel" data-bs-slide="prev" 
                                style="width: 30px;">
                            <span class="carousel-control-prev-icon" aria-hidden="true" 
                                  style="width: 20px; height: 20px;"></span>
                            <span class="visually-hidden">Anterior</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#productImageCarousel" data-bs-slide="next" 
                                style="width: 30px;">
                            <span class="carousel-control-next-icon" aria-hidden="true" 
                                  style="width: 20px; height: 20px;"></span>
                            <span class="visually-hidden">Siguiente</span>
                        </button>
                    ` : ''}
                </div>
            </div>
            ${controlesAjusteHtml}`; // Controles debajo del carrusel
    } else {
        carouselHtml = `
            <div class="product-image-container mb-3">
                <div style="height: 250px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                    <p class="text-muted">
                        <i class="fas fa-image fa-3x mb-2 d-block text-center" style="opacity: 0.3;"></i>
                        No hay imágenes disponibles
                    </p>
                </div>
            </div>
            ${controlesAjusteHtml}`; // Controles debajo del placeholder
    }
    
    let pdfLinkHtml = '<p class="text-center text-muted mt-3 mb-3">No hay ficha PDF disponible.</p>';
    if (producto.urlPdf && String(producto.urlPdf).trim() !== '') {
        pdfLinkHtml = `<div class="text-center mt-3 mb-3"><a href="${String(producto.urlPdf).trim()}" target="_blank" class="btn btn-danger"><i class="fas fa-file-pdf me-2"></i>Ver Ficha Técnica PDF</a></div>`;
    }

    const preciosHtml = tipoVista === 'interno' ? `
        <h6 class="text-primary mb-3">Información Comercial (Uso Interno)</h6>
        <table class="table table-sm table-striped">
            <tr><td colspan="3" class="bg-light text-dark"><strong>PRECIOS DE VENTA AL PÚBLICO (PVP)</strong></td></tr>
            <tr>
                <td style="width: 40%;">PVP (s/IVA) USD:</td>
                <td style="width: 30%;" class="fw-bold precio-venta-sin-iva">
                    $${pvpSinIVA.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}
                </td>
                <td style="width: 30%;">
                    <small class="text-muted precio-ars precio-venta-ars-sin-iva" data-precio-usd="${pvpSinIVA}">AR$ ${(pvpSinIVA*cotizacionUSD).toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}</small>
                </td>
            </tr>
            <tr><td>IVA:</td><td colspan="2">${ivaPct}%</td></tr>
            <tr>
                <td>PVP (c/IVA) USD:</td>
                <td class="fw-bold text-primary precio-venta-con-iva">
                    $${pvpConIVA.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}
                </td>
                <td>
                    <small class="text-muted precio-ars precio-venta-ars-con-iva" data-precio-usd="${pvpConIVA}">AR$ ${(pvpConIVA*cotizacionUSD).toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}</small>
                </td>
            </tr>
            
            <tr><td colspan="3" class="bg-light text-dark mt-2"><strong>SUS CONDICIONES DE COMPRA (Revendedor)</strong></td></tr>
            ${bonifGralPct > 0 ? `<tr><td>Bonificación General:</td><td colspan="2">${bonifGralPct}% sobre PVP s/IVA</td></tr>` : ''}
            ${descContadoPct > 0 ? `<tr><td>Descuento Adicional Contado:</td><td colspan="2">${descContadoPct}% (sobre neto bonificado)</td></tr>` : ''}
            <tr>
                <td>Su Costo Contado (s/IVA) USD:</td>
                <td class="text-success fw-bold">
                    $${costoContadoSinIVA.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}
                </td>
                <td>
                    <small class="text-muted precio-ars" data-precio-usd="${costoContadoSinIVA}">AR$ ${(costoContadoSinIVA*cotizacionUSD).toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}</small>
                </td>
            </tr>
            <tr>
                <td><strong>Su Costo Contado (c/IVA) USD:</strong></td>
                <td class="text-success fw-bold">
                    $${costoContadoConIVA.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}
                </td>
                <td>
                    <small class="text-muted precio-ars" data-precio-usd="${costoContadoConIVA}">AR$ ${(costoContadoConIVA*cotizacionUSD).toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}</small>
                </td>
            </tr>
            
            ${producto.financiacion ? `
            <tr><td>Plan Financiación (para usted):</td><td colspan="2">${producto.financiacion}</td></tr>
            ${bonifFinancPct > 0 ? `<tr><td>Bonificación por Financiación:</td><td colspan="2">${bonifFinancPct}% sobre PVP s/IVA</td></tr>` : ''}
            <tr>
                <td>Su Costo Financiado (s/IVA) USD:</td>
                <td class="text-info fw-bold">
                    $${costoFinancSinIVA.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}
                </td>
                <td>
                    <small class="text-muted precio-ars" data-precio-usd="${costoFinancSinIVA}">AR$ ${(costoFinancSinIVA*cotizacionUSD).toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}</small>
                </td>
            </tr>
            <tr>
                <td><strong>Su Costo Financiado (c/IVA) USD:</strong></td>
                <td class="text-info fw-bold">
                    $${costoFinancConIVA.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}
                </td>
                <td>
                    <small class="text-muted precio-ars" data-precio-usd="${costoFinancConIVA}">AR$ ${(costoFinancConIVA*cotizacionUSD).toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}</small>
                </td>
            </tr>
            ` : ''}
            ${rentabilidadHtml}
        </table>
        ` : `
        <h6 class="text-primary mb-3">Precios al Público</h6>
        <table class="table table-sm table-striped">
            <tr>
                <td style="width: 40%;"><strong>Precio Público (s/IVA) USD:</strong></td>
                <td style="width: 30%;" class="fw-bold precio-venta-sin-iva">
                    $${pvpSinIVA.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}
                </td>
                <td style="width: 30%;">
                    <small class="text-muted precio-ars precio-venta-ars-sin-iva" data-precio-usd="${pvpSinIVA}">AR$ ${(pvpSinIVA*cotizacionUSD).toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}</small>
                </td>
            </tr>
            <tr>
                <td><strong>Precio Público (c/IVA) USD:</strong></td>
                <td class="fw-bold text-primary precio-venta-con-iva">
                    $${pvpConIVA.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}
                </td>
                <td>
                    <small class="text-muted precio-ars precio-venta-ars-con-iva" data-precio-usd="${pvpConIVA}">AR$ ${(pvpConIVA*cotizacionUSD).toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2})}</small>
                </td>
            </tr>
        </table>
        <p class="form-text small mt-2">Los precios son finales para el consumidor. Consulte por planes de financiación si están disponibles.</p>
        `;

    const detallesHtml = `
        <div style="text-align: center; margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border-radius: 15px; border: 3px solid #FF6B35;">
            ${getKorLogo('medium', true)}
            <p style="color: #333; margin: 1rem 0 0 0; font-weight: 600;">
                <i class="fas fa-phone" style="color: #FF6B35;"></i> 11 3956 3099 | 
                <i class="fas fa-globe" style="color: #FF6B35;"></i> www.generadores.ar | 
                <i class="fas fa-envelope" style="color: #FF6B35;"></i> info@generadores.ar
            </p>
        </div>
        
        <div class="row">
            <div class="col-lg-5">
                ${carouselHtml}
                ${pdfLinkHtml}
            </div>
            
            <div class="col-lg-7">
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">Información General</h6>
                        <table class="table table-sm table-striped">
                            <tr><td style="width: 40%;"><strong>Familia:</strong></td><td><span class="badge bg-primary">${producto.familia}</span></td></tr>
                            <tr><td><strong>Modelo:</strong></td><td><strong>${producto.modelo}</strong></td></tr>
                            <tr><td><strong>Marca:</strong></td><td>${producto.marca || '-'}</td></tr>
                            <tr><td><strong>Potencia:</strong></td><td>${formatPotenciaDetalles(producto)}</td></tr>
                            <tr><td><strong>Motor:</strong></td><td>${producto.motor || '-'}</td></tr>
                            <tr><td><strong>Combustible:</strong></td><td>${producto.combustible ? `<span class="badge bg-${getCombustibleColor(producto.combustible)}">${producto.combustible}</span>` : '-'}</td></tr>
                            <tr><td><strong>Cabina:</strong></td><td>${producto.cabina || '-'}</td></tr>
                            <tr><td><strong>Stock:</strong></td><td><span class="badge bg-${getStockColor(producto.stock)}">${producto.stock}</span></td></tr>
                        </table>
                    </div>
                    
                    <div class="col-12 mt-3">
                        <!-- Panel de Cotización integrado -->
                        <div style="background: #FFD23F; border-radius: 8px; padding: 10px; margin-bottom: 15px; border: 2px solid #FF6B35;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <strong style="color: #000;">Cotización USD/ARS:</strong>
                                    <span id="cotizacionModalValor" style="font-size: 1.2rem; font-weight: 900; color: #FF6B35;">
                                        $${cotizacionUSD.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    </span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="date" id="fechaCotizacionModal" value="${fechaCotizacionActual}" 
                                           class="form-control form-control-sm" style="width: 150px;">
                                    <button class="btn btn-sm" onclick="actualizarCotizacionDesdeModal()" 
                                            style="background: #FF6B35; color: white; border: none;">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${preciosHtml}
                    </div>
                </div>
            </div>
        </div>
        
        ${producto.descripcion || producto.caracteristicas ? `
        <div class="row mt-3">
            <div class="col-12">
                ${producto.descripcion ? `
                <div class="mb-3">
                    <h6 class="text-primary">Descripción</h6>
                    <p class="small" style="white-space: pre-wrap;">${producto.descripcion}</p>
                </div>
                ` : ''}
                ${producto.caracteristicas ? `
                <div class="mb-3">
                    <h6 class="text-primary">Características Especiales</h6>
                    <p class="small" style="white-space: pre-wrap;">${producto.caracteristicas}</p>
                </div>
                ` : ''}
            </div>
        </div>
        ` : ''}
        ${producto.observaciones ? `<div class="mt-2"><h6 class="text-primary">Observaciones Internas</h6><p style="white-space: pre-wrap;">${producto.observaciones}</p></div>` : ''}
    `;
    
    $('#detallesModalBody').html(detallesHtml).attr('data-tipo-vista', tipoVista); // Guardar tipo de vista
    $('#detallesModalLabel').text(`Detalles del Producto`);
    const detallesModal = new bootstrap.Modal(document.getElementById('detallesModal'));
    detallesModal.show();
    
    // Configurar el selector de fecha del modal
    const fechaModalInput = document.getElementById('fechaCotizacionModal');
    if (fechaModalInput && evolucionDataOficial.length > 0) {
        const hoy = new Date();
        fechaModalInput.max = toYYYYMMDD(hoy);
        fechaModalInput.min = evolucionDataOficial[0].date;
    }
    
    const carouselElement = document.getElementById('productImageCarousel');
    if (carouselElement) {
        new bootstrap.Carousel(carouselElement);
    }
    // Aplicar ajustes iniciales (precios originales)
    actualizarPreciosConAjustes();
}

function formatPotenciaDetalles(producto) {
    if (!producto) return '-';
    
    const original = producto.potenciaCompleta || '-';
    const formateado = producto.potenciaFormateada || '';
    
    if (original !== formateado && formateado && formateado !== '-') {
        return `${original} (${formateado})`;
    }
    return original;
}

function getCombustibleColor(combustible) {
    if (!combustible) return 'secondary';
    const c = String(combustible).toLowerCase();

    if (c.includes('gas') && !c.includes('nafta')) {
        return 'warning';
    } else if (c.includes('nafta') && !c.includes('gas')) {
        return 'success';
    } else if (c.includes('diesel')) {
        return 'primary';
    } else if (c.includes('nafta') && c.includes('gas')) {
        return 'info';
    } else if (c.includes('eléctrico')) {
        return 'dark';
    }
    return 'secondary';
}

function getStockColor(stock) {
    if (!stock) return 'secondary';
    const s = String(stock).toLowerCase();
    if (s === 'disponible') return 'success';
    if (s === 'sin stock') return 'danger';
    if (s === 'consultar') return 'warning';
    return 'secondary';
}

function mostrarModalExportacion() {
    $('#exportacionModal').modal('show');
}

function exportarTablaActualAExcel() {
    const tipoExportacion = $('input[name="tipoExportacion"]:checked').val();
    mostrarCargando();
    
    const datosFiltrados = dataTable.rows({ search: 'applied' }).data().toArray();
    
    if (datosFiltrados.length === 0) {
        mostrarNotificacion('No hay datos en la tabla para exportar.', 'warning');
        ocultarCargando();
        return;
    }

    const datosExportacion = datosFiltrados.map(producto => {
        const precioVentaConIVA = (producto.precio || 0) * (1 + (producto.iva || 0)/100);
        
        let datoBase = {
            'Familia': producto.familia,
            'Modelo': producto.modelo,
            'Marca': producto.marca || '',
            'Descripción': producto.descripcion || '',
            'Potencia': producto.potenciaCompleta || '',
            'Motor': producto.motor || '',
            'Combustible': producto.combustible || '',
            'Cabina': producto.cabina || '',
            'TTA Incluido': producto.tta || '',
            'Precio Venta s/IVA USD': producto.precio,
            'Precio Venta c/IVA USD': precioVentaConIVA.toFixed(2),
            'Precio Venta c/IVA ARS': (precioVentaConIVA * cotizacionUSD).toFixed(2),
            'Stock': producto.stock,
            'URL Ficha PDF': producto.urlPdf || '',
            'Cotización USD': cotizacionUSD,
            'Fecha Cotización': fechaCotizacionActual
        };
        
        if (tipoExportacion === 'interno') {
            const costoBase = producto.precioCompraSinIVA || 0;
            const bonificacion = producto.bonificacion || 0;
            const descuentoContado = producto.descuentoContado || 0;
            const costoConBonificacion = costoBase * (1 - bonificacion / 100);
            const costoContado = costoConBonificacion * (1 - descuentoContado / 100);
            
            let margenContado = '';
            if (costoContado > 0 && producto.precio > 0) {
                margenContado = (((producto.precio - costoContado) / costoContado) * 100).toFixed(2) + '%';
            }
            
            return {
                ...datoBase,
                'Peso (kg)': producto.peso || '',
                'Dimensiones': producto.dimensiones || '',
                'Costo Lista Proveedor s/IVA USD': producto.precioCompraSinIVA,
                'Bonificación %': producto.bonificacion || '',
                'Desc. Contado %': producto.descuentoContado || '',
                'Mi Costo Contado s/IVA USD': costoContado.toFixed(2),
                'Mi Costo Contado c/IVA USD': (costoContado * (1 + (producto.iva || 0)/100)).toFixed(2),
                'Mi Costo Contado c/IVA ARS': (costoContado * (1 + (producto.iva || 0)/100) * cotizacionUSD).toFixed(2),
                'Plan Financiación': producto.financiacion || '',
                'Bonif. Financiación %': producto.bonificacionFinanciacion || '',
                'Margen sobre costo contado': margenContado,
                'IVA %': producto.iva,
                'Características': producto.caracteristicas || '',
                'Observaciones Internas': producto.observaciones || ''
            };
        }
        return datoBase;
    });

    const ws = XLSX.utils.json_to_sheet(datosExportacion);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Productos Filtrados");
    
    const fileName = `Catalogo_KOR_${tipoExportacion}_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    setTimeout(() => {
        ocultarCargando();
        $('#exportacionModal').modal('hide');
        mostrarNotificacion('Archivo Excel exportado correctamente.', 'success');
    }, 500);
}

function exportarProductoSeleccionadoExcel() {
    if (!productoSeleccionadoParaExportar) {
        mostrarNotificacion('No hay producto seleccionado para exportar.', 'warning');
        return;
    }
    
    mostrarCargando();
    const producto = productoSeleccionadoParaExportar;
    const precioConIVA = (producto.precio || 0) * (1 + (producto.iva || 0)/100);
    
    let rentabilidadSinIVA = '';
    if (producto.precioCompraSinIVA > 0 && producto.precio > 0) {
        rentabilidadSinIVA = (((producto.precio - producto.precioCompraSinIVA) / producto.precioCompraSinIVA) * 100).toFixed(2) + '%';
    }
    
    const datosExportacion = [{
        'Familia': producto.familia,
        'Modelo': producto.modelo,
        'Marca': producto.marca || '',
        'Descripción': producto.descripcion || '',
        'Potencia': producto.potenciaCompleta || '',
        'Motor': producto.motor || '',
        'Combustible': producto.combustible || '',
        'Cabina': producto.cabina || '',
        'TTA Incluido': producto.tta || '',
        'Peso (kg)': producto.peso || '',
        'Dimensiones': producto.dimensiones || '',
        'Precio Compra s/IVA USD': producto.precioCompraSinIVA,
        'Precio Venta s/IVA USD': producto.precio,
        'IVA %': producto.iva,
        'Precio Venta c/IVA USD': precioConIVA.toFixed(2),
        'Precio Venta c/IVA ARS': (precioConIVA * cotizacionUSD).toFixed(2),
        'Bonificación %': producto.bonificacion || '',
        'Desc. Contado %': producto.descuentoContado || '',
        'Plan Financiación': producto.financiacion || '',
        'Bonif. Financiación %': producto.bonificacionFinanciacion || '',
        'Rentabilidad s/IVA': rentabilidadSinIVA,
        'Stock': producto.stock,
        'Características': producto.caracteristicas || '',
        'Observaciones': producto.observaciones || '',
        'URL Ficha PDF': producto.urlPdf || '',
        'URL Imagen 1': producto.imagenes[0] || '',
        'URL Imagen 2': producto.imagenes[1] || '',
        'URL Imagen 3': producto.imagenes[2] || '',
        'Cotización USD': cotizacionUSD,
        'Fecha Cotización': fechaCotizacionActual
    }];

    const ws = XLSX.utils.json_to_sheet(datosExportacion);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Detalle Producto");
    
    const fileName = `Detalle_${(producto.modelo || 'Producto').replace(/[^\w\s-]/gi, '').replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    setTimeout(() => {
        ocultarCargando();
        mostrarNotificacion('Detalle del producto exportado correctamente.', 'success');
    }, 500);
}

function imprimirModal() {
    if (!productoSeleccionadoParaExportar) {
        mostrarNotificacion('No hay producto seleccionado para imprimir.', 'warning');
        return;
    }
    
    const producto = productoSeleccionadoParaExportar;
    
    const imagenes = producto.imagenes ? producto.imagenes.slice(0, 4) : [];
    let imagenesHtml = '';
    
    if (imagenes.length > 0) {
        imagenesHtml = '<div class="images-grid">';
        for (let i = 0; i < 4; i++) {
            if (imagenes[i]) {
                imagenesHtml += `<div class="image-cell"><img src="${imagenes[i]}" alt="Imagen ${i + 1}" onerror="this.src='https://placehold.co/200x150/EEE/CCC?text=Sin+imagen'"></div>`;
            } else {
                imagenesHtml += `<div class="image-cell"><div class="no-image">Sin imagen</div></div>`;
            }
        }
        imagenesHtml += '</div>';
    }
    
    // --- INICIO CORRECCIÓN: Aplicar ajustes de precios para impresión ---
    const pvpSinIVA_original = producto.precio || 0;
    const ivaPct = producto.iva || 0;
    
    // Aplicar margen adicional
    const pvpConMargen = pvpSinIVA_original * (1 + margenAdicionalTemporal / 100);
    
    // Aplicar descuento
    const precioVentaSinIVA = pvpConMargen * (1 - descuentoClienteTemporal / 100);
    const precioVentaConIVA = precioVentaSinIVA * (1 + ivaPct / 100);
    // --- FIN CORRECCIÓN ---
    
    let datosComerciales = `
        <tr><td><strong>Precio Venta s/IVA:</strong></td><td>$${precioVentaSinIVA.toFixed(2)}</td></tr>
        <tr><td><strong>Precio Venta c/IVA:</strong></td><td><strong>$${precioVentaConIVA.toFixed(2)}</strong></td></tr>
        <tr><td><strong>Cotización USD:</strong></td><td>AR$ ${cotizacionUSD.toFixed(2)}</td></tr>
        <tr><td><strong>Precio en Pesos:</strong></td><td><strong>AR$ ${(precioVentaConIVA * cotizacionUSD).toLocaleString('es-AR')}</strong></td></tr>
    `;
    
    const printWindow = window.open('', 'PRINT', 'height=800,width=1000');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${producto.modelo} - KOR Generadores</title>
            <style>
                @page { size: A4; margin: 10mm; }
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { font-family: Arial, sans-serif; font-size: 11px; line-height: 1.4; color: #333; }
                .container { width: 100%; max-width: 100%; }
                .header { text-align: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 3px solid #FF6B35; position: relative; }
                .kor-logo-print { font-size: 48px; font-weight: 900; letter-spacing: 4px; margin-bottom: 5px; }
                .kor-logo-print .k { color: #FF6B35; }
                .kor-logo-print .or { color: #000000; }
                .kor-innovacion-print { font-size: 14px; letter-spacing: 3px; color: #666; font-weight: 300; }
                .header h2 { font-size: 14px; color: #FF6B35; margin-top: 5px; }
                .contact-bar { background: #000; color: #FFD23F; padding: 5px; margin-bottom: 10px; text-align: center; font-size: 10px; font-weight: bold; }
                .contact-bar span { margin: 0 10px; }
                .cotizacion-bar { background: #FFD23F; color: #000; padding: 8px; margin-bottom: 10px; text-align: center; font-weight: bold; border: 2px solid #FF6B35; }
                .images-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 140px 140px; gap: 8px; margin-bottom: 12px; }
                .image-cell { border: 2px solid #FFD23F; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #f9f9f9; }
                .image-cell img { max-width: 100%; max-height: 100%; object-fit: contain; }
                .no-image { color: #999; font-size: 12px; }
                .info-section { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }
                .info-table { width: 100%; }
                .info-table h3 { font-size: 12px; margin-bottom: 5px; padding: 4px; background: linear-gradient(90deg, #000 0%, #333 100%); color: #FFD23F; text-align: center; }
                .info-table table { width: 100%; font-size: 10px; }
                .info-table td { padding: 3px 4px; border-bottom: 1px solid #eee; }
                .info-table td:first-child { font-weight: bold; width: 40%; color: #000; }
                .description-section { margin-top: 10px; padding-top: 8px; border-top: 2px solid #FF6B35; }
                .description-section h3 { font-size: 12px; margin-bottom: 5px; color: #000; }
                .description-section p { font-size: 10px; line-height: 1.3; text-align: justify; }
                .badge { display: inline-block; padding: 2px 6px; font-size: 9px; font-weight: bold; border-radius: 3px; color: white; }
                .badge-primary { background: #000; } .badge-success { background: #27ae60; } .badge-danger { background: #e74c3c; }
                .badge-warning { background: #FFD23F; color: #000; } .badge-info { background: #FF6B35; } .badge-secondary { background: #6c757d; }
                .footer { margin-top: 12px; padding-top: 8px; border-top: 3px solid #FFD23F; background: #000; color: #fff; padding: 8px; text-align: center; }
                .footer .contact { font-size: 10px; margin-bottom: 3px; }
                .footer .contact span { color: #FFD23F; margin: 0 8px; }
                @media print { body { margin: 0; } .container { page-break-inside: avoid; } }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <div class="kor-logo-print">
                        <span class="k">K</span><span class="or">OR</span>
                    </div>
                    <div class="kor-innovacion-print">INNOVACIÓN</div>
                    <h2>${producto.modelo} ${producto.marca ? '- ' + producto.marca : ''}</h2>
                </div>
                
                <div class="contact-bar">
                    <span>📱 11 3956 3099</span>
                    <span>🌐 www.generadores.ar</span>
                    <span>✉️ info@generadores.ar</span>
                </div>
                
                <div class="cotizacion-bar">
                    COTIZACIÓN USD/ARS: $${cotizacionUSD.toFixed(2)} - Fecha: ${formatDate(new Date(fechaCotizacionActual + 'T12:00:00'))}
                </div>
                
                ${imagenesHtml}
                
                <div class="info-section">
                    <div class="info-table">
                        <h3>INFORMACIÓN TÉCNICA</h3>
                        <table>
                            <tr><td>Potencia:</td><td>${formatPotenciaDetalles(producto)}</td></tr>
                            <tr><td>Motor:</td><td>${producto.motor || '-'}</td></tr>
                            <tr><td>Combustible:</td><td>${producto.combustible ? `<span class="badge badge-${getCombustibleColorForPrint(producto.combustible)}">${producto.combustible}</span>` : '-'}</td></tr>
                            <tr><td>Cabina:</td><td>${producto.cabina || '-'}</td></tr>
                            <tr><td>TTA:</td><td>${producto.tta === 'Si' ? '<span class="badge badge-success">Incluido</span>' : '<span class="badge badge-secondary">No incluido</span>'}</td></tr>
                            <tr><td>Peso:</td><td>${producto.peso ? producto.peso + ' kg' : '-'}</td></tr>
                            <tr><td>Dimensiones:</td><td>${producto.dimensiones || '-'}</td></tr>
                            <tr><td>Stock:</td><td><span class="badge badge-${getStockColorForPrint(producto.stock)}">${producto.stock || 'Consultar'}</span></td></tr>
                        </table>
                    </div>
                    
                    <div class="info-table">
                        <h3>INFORMACIÓN COMERCIAL</h3>
                        <table>
                            ${datosComerciales}
                            ${producto.financiacion ? `<tr><td>Financiación:</td><td>${producto.financiacion}</td></tr>` : ''}
                        </table>
                    </div>
                </div>
                
                ${producto.descripcion || producto.caracteristicas ? `
                <div class="description-section">
                    ${producto.descripcion ? `<h3>Descripción</h3><p>${producto.descripcion}</p>` : ''}
                    ${producto.caracteristicas ? `<h3>Características Especiales</h3><p>${producto.caracteristicas}</p>` : ''}
                </div>
                ` : ''}
                
                <div class="footer">
                    <div class="contact">
                        <span>📱 11 3956 3099</span>
                        <span>🌐 www.generadores.ar</span>
                        <span>✉️ info@generadores.ar</span>
                    </div>
                    <div style="font-size: 20px; font-weight: 900; margin-top: 5px;">
                        <span style="color: #FF6B35;">K</span><span style="color: #FFF;">OR</span>
                        <span style="font-size: 12px; font-weight: 300; color: #FFD23F;">GENERADORES</span>
                    </div>
                    <div style="font-size: 9px; color: #FFD23F; margin-top: 3px;">
                        ${new Date().toLocaleDateString('es-AR')} - Cotización USD: $${cotizacionUSD.toFixed(2)}
                    </div>
                </div>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 1500);
}

// Funciones auxiliares para los colores en impresión
function getCombustibleColorForPrint(combustible) {
    if (!combustible) return 'secondary';
    const c = String(combustible).toLowerCase();
    
    if (c.includes('gas') && !c.includes('nafta')) return 'warning';
    else if (c.includes('nafta') && !c.includes('gas')) return 'success';
    else if (c.includes('diesel')) return 'primary';
    else if (c.includes('nafta') && c.includes('gas')) return 'info';
    else if (c.includes('eléctrico')) return 'secondary';
    return 'secondary';
}

function getStockColorForPrint(stock) {
    if (!stock) return 'secondary';
    const s = String(stock).toLowerCase();
    if (s === 'disponible') return 'success';
    if (s === 'sin stock') return 'danger';
    if (s === 'consultar') return 'warning';
    return 'secondary';
}

function mostrarEstadisticas() {
    $('#statisticsRow').slideToggle();
    if ($('#statisticsRow').is(':visible')) {
        actualizarEstadisticas();
    }
}

function actualizarEstadisticas() {
    $('#totalProductos').text(productos.length);
    $('#totalFamilias').text([...new Set(productos.map(p => p.familia).filter(Boolean))].length);
    $('#totalStock').text(productos.filter(p => p.stock === 'Disponible').length);
    $('#totalSinStock').text(productos.filter(p => p.stock === 'Sin Stock' || p.stock === 'Consultar').length);
}

function mostrarCargando() {
    $('#loadingOverlay').css('display', 'flex');
}

function ocultarCargando() {
    $('#loadingOverlay').hide();
}

function mostrarNotificacion(mensaje, tipo, duracion = 7000) {
    const alertId = `notificacion-${Date.now()}`;
    const alertClass = tipo === 'success' ? 'alert-success' : (tipo === 'danger' ? 'alert-danger' : 'alert-warning');
    const icono = tipo === 'success' ? 'check-circle' : (tipo === 'danger' ? 'exclamation-triangle' : 'exclamation-circle');
    
    const alertHtml = `
        <div id="${alertId}" class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow-sm" role="alert" style="z-index: 10000;">
            <i class="fas fa-${icono} me-2"></i>${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>`;
    
    $('body').append(alertHtml);
    setTimeout(() => {
        const alertElement = document.getElementById(alertId);
        if (alertElement) {
            bootstrap.Alert.getOrCreateInstance(alertElement).close();
        }
    }, duracion);
}

$('#busquedaTexto').on('keypress', function(e) {
    if (e.which === 13) {
        aplicarFiltros();
    }
});

$(window).on('resize', function() {
    if (dataTable && typeof dataTable.responsive === 'object' && typeof dataTable.responsive.recalc === 'function') {
        dataTable.columns.adjust();
        dataTable.responsive.recalc();
    } else if (dataTable && dataTable.columns && typeof dataTable.columns.adjust === 'function') {
        dataTable.columns.adjust();
    }
});

// Verificar si hay datos embebidos al cargar la página
$(document).ready(function() {
    setTimeout(function() {
        if (window.CATALOGO_KOR_EMBEBIDO && window.CATALOGO_KOR_EMBEBIDO.productos && window.CATALOGO_KOR_EMBEBIDO.productos.length > 0) {
            const savedProducts = localStorage.getItem(STORAGE_KEYS.products);
            if (!savedProducts || savedProducts === '[]') {
                console.log('Catálogo embebido detectado - Cargando datos automáticamente');
            }
        }
    }, 100);
});

// Función para solicitar contraseña si está activada la seguridad
function checkSecurityOnLoad() {
    if (isSecurityEnabled && securityPassword) {
        const password = prompt('Ingrese la contraseña para acceder al catálogo:');
        if (!password || hashPassword(password) !== securityPassword) {
            alert('Contraseña incorrecta. Acceso denegado.');
            document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #000;"><h1 style="color: #FF6B35;">Acceso Denegado</h1></div>';
            return false;
        }
    }
    return true;
}

// Ejecutar verificación de seguridad al cargar
window.addEventListener('load', function() {
    if (!checkSecurityOnLoad()) {
        return;
    }
});

function recargarDatosAlmacenados() {
    mostrarCargando();
    setTimeout(() => {
        console.log("Intentando re-cargar datos almacenados...");
        loadSavedProducts(); // Intenta cargar desde localStorage
        if (productos && productos.length > 0) {
            finalizeDataLoading();
            mostrarNotificacion('Datos almacenados han sido re-cargados.', 'success');
        } else {
            ocultarCargando();
            mostrarNotificacion('No se encontraron datos almacenados para re-cargar.', 'info');
        }
    }, 250);
}
</script>
</body>
</html>
